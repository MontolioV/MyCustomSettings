// node version >= 16.6.0
import {readdir,} from 'fs/promises'
import {stat, constants, accessSync, rmSync} from 'fs';
import * as path from "path";

let rootPath = process.argv[2]
if (!rootPath) {
  throw new Error('Invalid use of the script: you must provide an absolute path to the target folder as a first argument')
}

async function main() {
  try {
    const files = await readdir(rootPath)
    files.forEach((fileName, fIdx) => {
      let absProjectFolderPath = path.join(rootPath, fileName)
      stat(absProjectFolderPath, (err, stats) => {
        if (err) throw err

        if (stats.isDirectory()) {
          let projectNodeModulesAbsPath = path.join(absProjectFolderPath, 'node_modules')
          try {
            accessSync(projectNodeModulesAbsPath, constants.R_OK | constants.W_OK)
            rmSync(projectNodeModulesAbsPath, {recursive: true})
            let progress = `${~~((fIdx / files.length) * 100)}%`
            console.log(progress, '\t', projectNodeModulesAbsPath, 'removed')
          } catch (e) {
            // ignore
          }
        }
      });
    })
  } catch (err) {
    console.error(err,)
  }
}

main()
